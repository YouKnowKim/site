package com.yonseidairy.site.service;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.net.HttpURLConnection;
import java.net.URL;
import java.net.URLEncoder;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.HashSet;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;
import java.util.Set;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.google.gson.JsonArray;
import com.google.gson.JsonElement;
import com.google.gson.JsonObject;
import com.google.gson.JsonParser;
import com.yonseidairy.site.dao.RegionDao;
import com.yonseidairy.site.mapper.RegionMapper;

@Service
public class RegionService {
	private static final String KAKAO_REST_API_KEY = "KakaoAK 70f55076ab1f80b4e69e90f9ec18c1b5";

	@Autowired
	private RegionMapper regionMapper;

	// ëª¨ë“  ê±°ë˜ì²˜ ìœ„ì¹˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
	public List<RegionDao> selectAllRegions(RegionDao inRegionDao) {
		List<RegionDao> result = new ArrayList<>();
		List<RegionDao> rawList = regionMapper.selectAllRegions(inRegionDao);

		for (RegionDao raw : rawList) {
			raw.setPolygon(parsePolygon(raw.getPolygon_coords()));

			result.add(raw);
		}

		return result;
	};

	// ìœ í†µ êµ¬ë¶„ì— ë”°ë¥¸ ìœ„ì¹˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
	public List<RegionDao> selectRegions(RegionDao inRegionDao) {

		List<RegionDao> result = new ArrayList<>();
		List<RegionDao> rawList = regionMapper.selectRegions(inRegionDao);

		for (RegionDao raw : rawList) {
			raw.setPolygon(parsePolygon(raw.getPolygon_coords()));

			result.add(raw);
		}

		return result;
	}

	// ì£¼ì†Œ ì¹´í…Œê³ ë¦¬ ê°€ì ¸ì˜¤ê¸°
	public Map<String, Set<String>> selectAddressCategories(RegionDao inRegionDao) {

		List<RegionDao> result = new ArrayList<>();
		List<RegionDao> rawList = regionMapper.selectAddressCategories(inRegionDao);

		// ì§€ì—­ëŒ€ë¶„ë¥˜ â†’ ì¤‘ë¶„ë¥˜ ë¦¬ìŠ¤íŠ¸ ì €ì¥ êµ¬ì¡°
		Map<String, Set<String>> categoryMap = new LinkedHashMap<>();

		for (RegionDao raw : rawList) {
			String cat1 = raw.getCategory1();
			String cat2 = raw.getCategory2();

			categoryMap.computeIfAbsent(cat1, k -> new HashSet<>()).add(cat2);
		}

		return categoryMap;
	}
	
	// ì‚¬ë²ˆ ìœ íš¨ì„± ê²€ì¦
	public HashMap<String, Boolean> checkSabun(RegionDao inRegionDao){
		
		HashMap<String, Boolean> result = new HashMap<>();
		
		RegionDao out = regionMapper.selectCheckSabun(inRegionDao);
		Integer cnt = out.getCnt();
		
		if (cnt > 0) {
			result.put("valid", true);
		} else {
			result.put("valid", false);
		}
		
		return result;
	}

	// ì£¼ì†Œì— ë”°ë¥¸ ì§€ì—­ ê°€ì ¸ì˜¤ê¸°
	public HashMap<String, String> getRegionByAddress(RegionDao inRegionDao) {

		HashMap<String, String> result = new HashMap<>();
		
		String address = inRegionDao.getAddress();
		String gubunType = inRegionDao.getGubunType();
		
		if (address == null || address.trim().isEmpty()) {
			result.put("error", "í•´ë‹¹ ì£¼ì†Œì— ë§¤í•‘ëœ ëŒ€ë¦¬ì ì´ ì—†ìŠµë‹ˆë‹¤.");
			return result;
		}
		
		try {
			// 1. ì£¼ì†Œ â†’ ì¢Œí‘œ ë³€í™˜ (Kakao REST API í˜¸ì¶œ)
			double[] coordinates = getCoordinatesFromAddress(address);
			double lat = coordinates[0];
			double lng = coordinates[1];

			// 2. ì¢Œí‘œê°€ í¬í•¨ëœ Region ì°¾ê¸° (ë©”ëª¨ë¦¬ ë‚´ íŒë‹¨)
			List<RegionDao> regions = new ArrayList<>();
			List<RegionDao> tempRegions = regionMapper.selectAllRegionsForAddress(inRegionDao); // ëª¨ë“  Region ë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
			
			for (RegionDao raw : tempRegions) {
				raw.setPolygon(parsePolygon(raw.getPolygon_coords()));

				regions.add(raw);
			}
			
			RegionDao matched = null;
			
			for (RegionDao region : regions) {
				if (pointInPolygon(lat, lng, region.getPolygon())) {
					matched = region;
					break;
				}
			}
			
			if (matched != null) {
				result.put("custNo", matched.getCode());
				result.put("custName", matched.getName());
				result.put("addr", matched.getAddr());
				result.put("gubun", matched.getGubun());
				result.put("tel", matched.getTel());
				result.put("result", "1");
			} else {
				result.put("error", "í•´ë‹¹ ì£¼ì†Œê°€ í¬í•¨ë˜ëŠ” ëŒ€ë¦¬ì ì´ ì—†ìŠµë‹ˆë‹¤.");
				result.put("result", "0");
			}

		} catch (Exception e) {
			result.put("error", "ì…ë ¥í•œ ì£¼ì†Œê°€ ê²€ìƒ‰ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì£¼ì†Œë¥¼ í™•ì¸í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.");
			result.put("result", "-1");
		}

		return result;
	}
	
	
	// ëŒ€ë¦¬ì ë³„ ê¶Œì—­ ì§€ì • ì—¬ë¶€ ê·¸ë¦¬ë“œ íŒì—… ì¡°íšŒ
	public List<RegionDao> getRegionSaveStatus(RegionDao inRegionDao){
		return regionMapper.selectRegionSaveStatus(inRegionDao);
	}
	
	public HashMap<String, String> saveRegion(RegionDao inRegionDao){
		
		HashMap<String, String> result = new HashMap<>();

////		// ì²« ë²ˆì§¸ ì ì˜ ìœ„ë„ (ì²« ë²ˆì§¸ í–‰, ì²« ë²ˆì§¸ ì—´)
		double centerLat = inRegionDao.getPolygonCoordsArray()[0][0];

////		// ì²« ë²ˆì§¸ ì ì˜ ê²½ë„ (ì²« ë²ˆì§¸ í–‰, ë‘ ë²ˆì§¸ ì—´)
		double centerLng = inRegionDao.getPolygonCoordsArray()[0][1];
		
		inRegionDao.setCenterLat(centerLat);
		inRegionDao.setCenterLng(centerLng);
		inRegionDao.setPolygonCoords(inRegionDao.getPolygon().toString());
		
		inRegionDao.setLatitude(centerLat);
		inRegionDao.setLongitude(centerLng);
		
		regionMapper.insertRegion(inRegionDao);
		regionMapper.insertLog(inRegionDao);
		
		result.put("success", "true");
		
		return result;
	}
	
	// ëŒ€ë¦¬ì  ê¶Œì—­ ì‚­ì œ
	public String deleteRegion(RegionDao inRegionDao) {
		
		String resultStr = "success";
		
		RegionDao checkDelete = regionMapper.selectForDelete(inRegionDao);
		
		// ì¡°íšŒ ì‹œ ì—†ìœ¼ë©´ ì‚­ì œ í•˜ì§€ ì•Šê³  ëë‚¨
		if(checkDelete == null) {
			resultStr = "No Data Found";
			return resultStr;
		}
		
		checkDelete.setRegionId(inRegionDao.getRegionId());
		checkDelete.setGubun("D");
		checkDelete.setGubunType(inRegionDao.getGubunType());
		
		regionMapper.deleteRegion(inRegionDao);
		regionMapper.insertLog(checkDelete);
		return resultStr;
	}

	// String ìœ„ì¹˜ ì •ë³´ë¥¼ JsonArrayë¡œ ë³€ê²½í•˜ëŠ” ë©”ì†Œë“œ
	private List<double[]> parsePolygon(String json) {
		List<double[]> list = new ArrayList<>();
		JsonArray array = JsonParser.parseString(json).getAsJsonArray();

		for (JsonElement elem : array) {
			JsonArray pair = elem.getAsJsonArray();
			double lat = pair.get(0).getAsDouble();
			double lng = pair.get(1).getAsDouble();
			list.add(new double[] { lat, lng });
		}

		return list;
	}

	// ğŸ§­ Kakao ì£¼ì†Œ â†’ ì¢Œí‘œ ë³€í™˜
	private double[] getCoordinatesFromAddress(String address) throws IOException {
		String encoded = URLEncoder.encode(address, "UTF-8");
		URL url = new URL("https://dapi.kakao.com/v2/local/search/address.json?query=" + encoded);

		HttpURLConnection conn = (HttpURLConnection) url.openConnection();
		conn.setRequestProperty("Authorization", KAKAO_REST_API_KEY);
		conn.setRequestMethod("GET");

		BufferedReader br = new BufferedReader(new InputStreamReader(conn.getInputStream()));
		StringBuilder json = new StringBuilder();
		String line;
		while ((line = br.readLine()) != null) {
			json.append(line);
		}
		br.close();

		JsonObject result = JsonParser.parseString(json.toString()).getAsJsonObject();
		if (result.getAsJsonArray("documents").size() == 0)
			throw new IllegalArgumentException("ì£¼ì†Œ ë³€í™˜ ê²°ê³¼ ì—†ìŒ");

		JsonObject pos = result.getAsJsonArray("documents").get(0).getAsJsonObject();
		double lat = pos.get("y").getAsDouble();
		double lng = pos.get("x").getAsDouble();

		return new double[] { lat, lng };
	}

	// ğŸ“Œ ì ì´ polygonì— í¬í•¨ëëŠ”ì§€ íŒë‹¨í•˜ëŠ” ì•Œê³ ë¦¬ì¦˜
	private boolean pointInPolygon(double lat, double lng, List<double[]> polygon) {
		boolean inside = false;
		int j = polygon.size() - 1;

		for (int i = 0; i < polygon.size(); i++) {
			double xi = polygon.get(i)[0], yi = polygon.get(i)[1];
			double xj = polygon.get(j)[0], yj = polygon.get(j)[1];

			boolean intersect = ((yi > lng) != (yj > lng)) && (lat < (xj - xi) * (lng - yi) / (yj - yi + 1e-10) + xi);
			if (intersect)
				inside = !inside;
			j = i;
		}

		return inside;
	}

}
