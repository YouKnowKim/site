package com.yonseidairy.site.service;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.net.HttpURLConnection;
import java.net.URL;
import java.net.URLEncoder;
import java.util.HashMap;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.google.gson.JsonObject;
import com.google.gson.JsonParser;
import com.yonseidairy.site.dao.AddressDao;
import com.yonseidairy.site.dao.RegionDao;
import com.yonseidairy.site.mapper.AddressMapper;

@Service
public class AddressService {
	private static final String KAKAO_REST_API_KEY = "KakaoAK 70f55076ab1f80b4e69e90f9ec18c1b5";
	
	@Autowired
	AddressMapper addressMapper;
	
	public HashMap<String, String> getRegionByAddress(AddressDao inAddressDao){
		
		HashMap<String, String> result = new HashMap<>();
		
		String address = inAddressDao.getAddress();
		
		if (address == null || address.trim().isEmpty()) {
			result.put("error", "í•´ë‹¹ ì£¼ì†Œì— ë§¤í•‘ëœ ëŒ€ë¦¬ì ì´ ì—†ìŠµë‹ˆë‹¤.");
            return result;
        }
		
		try {
			// 1. ì£¼ì†Œ â†’ ì¢Œí‘œ ë³€í™˜ (Kakao REST API í˜¸ì¶œ)
            double[] coordinates = getCoordinatesFromAddress(address);
            double lat = coordinates[0];
            double lng = coordinates[1];
            
            // 2. ì¢Œí‘œê°€ í¬í•¨ëœ Region ì°¾ê¸° (ë©”ëª¨ë¦¬ ë‚´ íŒë‹¨)
            List<RegionDao> regions = RegionService.getAllRegions(); // ëª¨ë“  Region ë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
            RegionDao matched = null;
            for (RegionDao region : regions) {
                if (pointInPolygon(lat, lng, region.getPolygon())) {
                    matched = region;
                    break;
                }
            }
			
		} catch (Exception e) {
			
		}
		
		return result;
	}
	
	// ğŸ§­ Kakao ì£¼ì†Œ â†’ ì¢Œí‘œ ë³€í™˜
    private double[] getCoordinatesFromAddress(String address) throws IOException {
        String encoded = URLEncoder.encode(address, "UTF-8");
        URL url = new URL("https://dapi.kakao.com/v2/local/search/address.json?query=" + encoded);

        HttpURLConnection conn = (HttpURLConnection) url.openConnection();
        conn.setRequestProperty("Authorization", KAKAO_REST_API_KEY);
        conn.setRequestMethod("GET");

        BufferedReader br = new BufferedReader(new InputStreamReader(conn.getInputStream()));
        StringBuilder json = new StringBuilder();
        String line;
        while ((line = br.readLine()) != null) {
            json.append(line);
        }
        br.close();

        JsonObject result = JsonParser.parseString(json.toString()).getAsJsonObject();
        if (result.getAsJsonArray("documents").size() == 0)
            throw new IllegalArgumentException("ì£¼ì†Œ ë³€í™˜ ê²°ê³¼ ì—†ìŒ");

        JsonObject pos = result.getAsJsonArray("documents").get(0).getAsJsonObject();
        double lat = pos.get("y").getAsDouble();
        double lng = pos.get("x").getAsDouble();

        return new double[]{lat, lng};
    }
    
 // ğŸ“Œ ì ì´ polygonì— í¬í•¨ëëŠ”ì§€ íŒë‹¨í•˜ëŠ” ì•Œê³ ë¦¬ì¦˜
    private boolean pointInPolygon(double lat, double lng, List<double[]> polygon) {
        boolean inside = false;
        int j = polygon.size() - 1;

        for (int i = 0; i < polygon.size(); i++) {
            double xi = polygon.get(i)[0], yi = polygon.get(i)[1];
            double xj = polygon.get(j)[0], yj = polygon.get(j)[1];

            boolean intersect = ((yi > lng) != (yj > lng)) &&
                    (lat < (xj - xi) * (lng - yi) / (yj - yi + 1e-10) + xi);
            if (intersect) inside = !inside;
            j = i;
        }

        return inside;
    }

}
