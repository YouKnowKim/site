package com.yonseidairy.site.service;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.net.HttpURLConnection;
import java.net.URL;
import java.net.URLEncoder;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.google.gson.JsonArray;
import com.google.gson.JsonElement;
import com.google.gson.JsonObject;
import com.google.gson.JsonParser;
import com.yonseidairy.site.dao.AddressDao;
import com.yonseidairy.site.dao.InfoByCustnoDao;
import com.yonseidairy.site.dao.RegionDao;
import com.yonseidairy.site.mapper.AddressMapper;

@Service
public class AddressService {
	private static final String KAKAO_REST_API_KEY = "KakaoAK 70f55076ab1f80b4e69e90f9ec18c1b5";

	@Autowired
	AddressMapper addressMapper;

	public HashMap<String, String> getRegionByAddress(AddressDao inAddressDao) {

		HashMap<String, String> result = new HashMap<>();

		String address = inAddressDao.getAddress();

		if (address == null || address.trim().isEmpty()) {
			result.put("error", "í•´ë‹¹ ì£¼ì†Œì— ë§¤í•‘ëœ ëŒ€ë¦¬ì ì´ ì—†ìŠµë‹ˆë‹¤.");
			return result;
		}

		try {
			// 1. ì£¼ì†Œ â†’ ì¢Œí‘œ ë³€í™˜ (Kakao REST API í˜¸ì¶œ)
			double[] coordinates = getCoordinatesFromAddress(address);
			double lat = coordinates[0];
			double lng = coordinates[1];

			// 2. ì¢Œí‘œê°€ í¬í•¨ëœ Region ì°¾ê¸° (ë©”ëª¨ë¦¬ ë‚´ íŒë‹¨)
			List<RegionDao> regions = new ArrayList<>();
			List<RegionDao> tempRegions = addressMapper.selectAllRegionsForAddress(); // ëª¨ë“  Region ë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
			
			for (RegionDao raw : tempRegions) {
				raw.setPolygon(parsePolygon(raw.getPolygon_coords()));

				regions.add(raw);
			}
			
			RegionDao matched = null;
			
			for (RegionDao region : regions) {
				if (pointInPolygon(lat, lng, region.getPolygon())) {
					matched = region;
					break;
				}
			}
			
			if (matched != null) {
				result.put("custNo", matched.getCode());
				result.put("custName", matched.getName());
				result.put("addr", matched.getAddr());
				result.put("gubun", matched.getGubun());
				result.put("tel", matched.getTel());
				result.put("result", "1");
			} else {
				result.put("error", "í•´ë‹¹ ì£¼ì†Œê°€ í¬í•¨ë˜ëŠ” ëŒ€ë¦¬ì ì´ ì—†ìŠµë‹ˆë‹¤.");
				result.put("result", "0");
			}

		} catch (Exception e) {
			result.put("error", "ì…ë ¥í•œ ì£¼ì†Œê°€ ê²€ìƒ‰ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì£¼ì†Œë¥¼ í™•ì¸í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.");
			result.put("result", "-1");
		}

		return result;
	}
	
	public List<InfoByCustnoDao> getInfoByCustno(InfoByCustnoDao inInfoDao){
		
		List<InfoByCustnoDao> result = new ArrayList<>();
		
		result = addressMapper.selectInfoByCustno(inInfoDao);
		
		return result;
	}

	// ğŸ§­ Kakao ì£¼ì†Œ â†’ ì¢Œí‘œ ë³€í™˜
	private double[] getCoordinatesFromAddress(String address) throws IOException {
		String encoded = URLEncoder.encode(address, "UTF-8");
		URL url = new URL("https://dapi.kakao.com/v2/local/search/address.json?query=" + encoded);

		HttpURLConnection conn = (HttpURLConnection) url.openConnection();
		conn.setRequestProperty("Authorization", KAKAO_REST_API_KEY);
		conn.setRequestMethod("GET");

		BufferedReader br = new BufferedReader(new InputStreamReader(conn.getInputStream()));
		StringBuilder json = new StringBuilder();
		String line;
		while ((line = br.readLine()) != null) {
			json.append(line);
		}
		br.close();

		JsonObject result = JsonParser.parseString(json.toString()).getAsJsonObject();
		if (result.getAsJsonArray("documents").size() == 0)
			throw new IllegalArgumentException("ì£¼ì†Œ ë³€í™˜ ê²°ê³¼ ì—†ìŒ");

		JsonObject pos = result.getAsJsonArray("documents").get(0).getAsJsonObject();
		double lat = pos.get("y").getAsDouble();
		double lng = pos.get("x").getAsDouble();

		return new double[] { lat, lng };
	}

	// ğŸ“Œ ì ì´ polygonì— í¬í•¨ëëŠ”ì§€ íŒë‹¨í•˜ëŠ” ì•Œê³ ë¦¬ì¦˜
	private boolean pointInPolygon(double lat, double lng, List<double[]> polygon) {
		boolean inside = false;
		int j = polygon.size() - 1;

		for (int i = 0; i < polygon.size(); i++) {
			double xi = polygon.get(i)[0], yi = polygon.get(i)[1];
			double xj = polygon.get(j)[0], yj = polygon.get(j)[1];

			boolean intersect = ((yi > lng) != (yj > lng)) && (lat < (xj - xi) * (lng - yi) / (yj - yi + 1e-10) + xi);
			if (intersect)
				inside = !inside;
			j = i;
		}

		return inside;
	}

	// String ìœ„ì¹˜ ì •ë³´ë¥¼ JsonArrayë¡œ ë³€ê²½í•˜ëŠ” ë©”ì†Œë“œ
	private List<double[]> parsePolygon(String json) {
		List<double[]> list = new ArrayList<>();
		JsonArray array = JsonParser.parseString(json).getAsJsonArray();

		for (JsonElement elem : array) {
			JsonArray pair = elem.getAsJsonArray();
			double lat = pair.get(0).getAsDouble();
			double lng = pair.get(1).getAsDouble();
			list.add(new double[] { lat, lng });
		}

		return list;
	}

}
